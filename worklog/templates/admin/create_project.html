{% extends 'base.html' %}
{% load staticfiles %}
{% block title %}新建项目{% endblock %}
{% block nav %}<li class="am-active">用户管理</li>{% endblock %}
{% block content %}

<script language='Javascript'>
    var config={
        "webRoot":"\/","appName":"","cookieLife":30,"requestType":"PATH_INFO",
        "requestFix":"-","moduleVar":"m","methodVar":"f","viewVar":"t","defaultView":"html",
        "themeRoot":"\/theme\/","currentModule":"project","currentMethod":"create",
        "clientLang":"zh-cn","requiredFields":"name,code,begin,end","router":"\/index.php",
        "save":"\u4fdd\u5b58","runMode":"","timeout":30000,"pingInterval":""};
    var lang={
        "submitting":"\u7a0d\u5019...","save":"\u4fdd\u5b58",
        "timeout":"\u8fde\u63a5\u8d85\u65f6\uff0c\u8bf7\u68c0\u67e5\u7f51\u7edc\u73af\u5883\uff0c\u6216\u91cd\u8bd5\uff01"};

</script>
<script src='http://cdn.zentaopm.com/9.2.1/js/all.js?v=pro6.3.1' type='text/javascript'></script>
<link rel='stylesheet' href='http://cdn.zentaopm.com/9.2.1/theme/default/zh-cn.default.css?v=pro6.3.1' type='text/css' media='screen' />
<style>.mgr-5px{margin-right:5px;}
body{
	background-color:#e9ecf3;
}
#tipsModal {margin-top: 10%;}
#begin + .input-group-addon {border-left: none; border-right: none;}
#begin,#end {max-width: 150px; width: auto}
#wrap1{
    background: #FFFFFF;
}
#copyProjectModal {padding: 0}
#copyProjectModal {padding: 0 2px}
#copyProjectModal > div {position: relative;}
#copyProjectModal a {display: block; min-height: 30px; line-height: 30px; padding: 5px 15px; border: 1px solid #e5e5e5; color: #333; margin: 5px 0}
#copyProjectModal a > i {display: inline-block; margin-right: 5px;}
#copyProjectModal a:hover {border:1px solid #39B3D7; background-color: #E5F9FF; text-decoration: none}
#copyProjectModal a.active {border-color: #229F24; color: #229F24; background-color: #E5FFE6}
#copyProjectModal a.active:after {position: absolute; content: '\e60d'; font-family: NewZenIcon; font-size: 20px; right: 25px;}
#copyProjectModal a.cancel {color: #D2322D}
.modal-dialog {margin-top: 10%!important;}

.checkbox input[type=checkbox], .checkbox-inline input[type=checkbox], .radio input[type=radio], .radio-inline input[type=radio] {margin-top: 1px;}

.type-tips {display: none; margin: 5px 0; color: #545454;}
</style><link rel='icon' href='http://cdn.zentaopm.com/favicon.ico' type='image/x-icon' />
<link rel='shortcut icon' href='http://cdn.zentaopm.com/favicon.ico' type='image/x-icon' />
<!--[if lt IE 9]>
<script src='http://cdn.zentaopm.com/9.2.1/js/html5shiv/min.js?v=pro6.3.1' type='text/javascript'></script>
<script src='http://cdn.zentaopm.com/9.2.1/js/respond/min.js?v=pro6.3.1' type='text/javascript'></script>
<![endif]-->
<!--[if lt IE 10]>
<script src='http://cdn.zentaopm.com/9.2.1/js/jquery/placeholder/min.js?v=pro6.3.1' type='text/javascript'></script>
<![endif]-->
</head>
<body>
<div id='wrap1' style="width: 100%; margin: 0 auto;">
  <div class='outer'>
<script language='javascript'>
$(function()
{
    $.fn.fixedDate = function()
    {
        return $(this).each(function()
        {
            var $this = $(this);
            if($this.offset().top + 200 > $(document.body).height())
            {
                $this.attr('data-picker-position', 'top-right');
            }

            if($this.val() == '0000-00-00')
            {
                $this.focus(function(){if($this.val() == '0000-00-00') $this.val('').datetimepicker('update');}).blur(function(){if($this.val() == '') $this.val('0000-00-00')});
            }
        });
    };

    var options =
    {
        language: 'zh-cn',
        weekStart: 1,
        todayBtn:  1,
        autoclose: 1,
        todayHighlight: 1,
        startView: 2,
        forceParse: 0,
        showMeridian: 1,
        format: 'yyyy-mm-dd hh:ii',
        startDate: '1970-1-1'
    }

    $('.form-datetime').fixedDate().datetimepicker(options);
    $('.form-date').fixedDate().datetimepicker($.extend(options, {minView: 2, format: 'yyyy-mm-dd'}));
    $('.form-time').fixedDate().datetimepicker($.extend(options, {startView: 1, minView: 0, maxView: 1, format: 'hh:ii'}));

    $('.datepicker-wrapper').click(function()
    {
        $(this).find('.form-date, .form-datetime, .form-time').datetimepicker('show').focus();
    });

    window.datepickerOptions = options;
});
</script>
<script language='Javascript'>themeRoot = "http:\/\/cdn.zentaopm.com\/9.2.1\/theme\/";</script>
<script language='Javascript'>kuid = 5963412019929;</script>
<link rel="stylesheet" href="http://cdn.zentaopm.com/9.2.1/js/kindeditor/themes/default/default.css" />
<script src='http://cdn.zentaopm.com/9.2.1/js/kindeditor/kindeditor-min.js' type='text/javascript'></script>
<script src='http://cdn.zentaopm.com/9.2.1/js/kindeditor/lang/zh_CN.js' type='text/javascript'></script>
<script language='javascript'>
var editor = {"id":["desc"],"tools":"simpleTools"};

var bugTools =
[ 'formatblock', 'fontname', 'fontsize', '|', 'forecolor', 'hilitecolor', 'bold', 'italic','underline', '|',
'justifyleft', 'justifycenter', 'justifyright', 'insertorderedlist', 'insertunorderedlist', '|',
'emoticons', 'image', 'code', 'link', '|', 'removeformat','undo', 'redo', 'fullscreen', 'source', 'about'];

var simpleTools =
[ 'formatblock', 'fontname', 'fontsize', '|', 'forecolor', 'hilitecolor', 'bold', 'italic','underline', '|',
'justifyleft', 'justifycenter', 'justifyright', 'insertorderedlist', 'insertunorderedlist', '|',
'emoticons', 'image', 'code', 'link', '|', 'removeformat','undo', 'redo', 'fullscreen', 'source', 'about'];

var fullTools =
[ 'formatblock', 'fontname', 'fontsize', 'lineheight', '|', 'forecolor', 'hilitecolor', '|', 'bold', 'italic','underline', 'strikethrough', '|',
'justifyleft', 'justifycenter', 'justifyright', 'justifyfull', '|',
'insertorderedlist', 'insertunorderedlist', '|',
'emoticons', 'image', 'insertfile', 'hr', '|', 'link', 'unlink', '/',
'undo', 'redo', '|', 'selectall', 'cut', 'copy', 'paste', '|', 'plainpaste', 'wordpaste', '|', 'removeformat', 'clearhtml','quickformat', '|',
'indent', 'outdent', 'subscript', 'superscript', '|',
'table', 'code', '|', 'pagebreak', 'anchor', '|',
'fullscreen', 'source', 'preview', 'about'];

//富文本编辑器
$(document).ready(initKindeditor);
function initKindeditor(afterInit)
{
    $(':input[type=submit]').next('#uid').remove();
    $(':input[type=submit]').after("<input type='hidden' id='uid' name='uid' value=" + kuid + ">");
    var nextFormControl = 'input:not([type="hidden"]), textarea:not(.ke-edit-textarea), button[type="submit"], select';
    $.each(editor.id, function(key, editorID)
    {
        editorTool = simpleTools;
        if(editor.tools == 'bugTools')  editorTool = bugTools;
        if(editor.tools == 'fullTools') editorTool = fullTools;

        var K = KindEditor, $editor = $('#' + editorID);
        var placeholderText = $editor.attr('placeholder');
        if(placeholderText == undefined) placeholderText = '';
        var pasted;
        var options =
        {
            cssPath:[themeRoot + 'zui/css/min.css'],
            width:'100%',
            items:editorTool,
            filterMode: true,
            bodyClass:'article-content',
            urlType:'relative',
            uploadJson: createLink('file', 'ajaxUpload', 'uid=' + kuid),
            allowFileManager:true,
            langType:'zh_CN',
            afterChange: function(){$editor.change().hide();},
            afterCreate : function()
            {
                var frame = this.edit;
                var doc   = this.edit.doc;
                var cmd   = this.edit.cmd;
                pasted    = true;
                if(!K.WEBKIT && !K.GECKO)
                {
                    var pasted = false;
                    $(doc.body).bind('paste', function(ev)
                    {
                        pasted = true;
                        return true;
                    });
                    setTimeout(function()
                    {
                        $(doc.body).bind('keyup', function(ev)
                        {
                            if(pasted)
                            {
                                pasted = false;
                                return true;
                            }
                            if(ev.keyCode == 86 && ev.ctrlKey) alert('您的浏览器不支持粘贴图片！');
                        })
                    }, 10);
                }
                if(pasted && placeholderText.indexOf('可以在编辑器直接贴图。') < 0)
                {
                    if(placeholderText) placeholderText += '<br />';
                    placeholderText += ' 可以在编辑器直接贴图。';
                }

                /* Paste in chrome.*/
                /* Code reference from http://www.foliotek.com/devblog/copy-images-from-clipboard-in-javascript/. */
                if(K.WEBKIT)
                {
                    $(doc.body).bind('paste', function(ev)
                    {
                        var $this    = $(this);
                        var original = ev.originalEvent;
                        var file     = original.clipboardData.items[0].getAsFile();
                        if(file)
                        {
                            var reader = new FileReader();
                            reader.onload = function(evt)
                            {
                                var result = evt.target.result;
                                var arr    = result.split(",");
                                var data   = arr[1]; // raw base64
                                var contentType = arr[0].split(";")[0].split(":")[1];

                                html = '<img src="' + result + '" alt="" />';
                                $.post(createLink('file', 'ajaxPasteImage', 'uid=' + kuid), {editor: html}, function(data){cmd.inserthtml(data);});
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }
                /* Paste in firefox and other firefox.*/
                else
                {
                    K(doc.body).bind('paste', function(ev)
                    {
                        setTimeout(function()
                        {
                            var html = K(doc.body).html();
                            if(html.search(/<img src="data:.+;base64,/) > -1)
                            {
                                $.post(createLink('file', 'ajaxPasteImage', 'uid=' + kuid), {editor: html}, function(data)
                                {
                                    if(data.indexOf('<img') == 0) data = '<p>' + data + '</p>';
                                    frame.html(data);
                                });
                            }
                        }, 80);
                    });
                }
                /* End */

                /* Add for placeholder. */
                $(this.edit.doc).find('body').after('<span class="kindeditor-ph" style="width:100%;color:#888; padding:5px 5px 5px 7px; background-color:transparent; position:absolute;z-index:10;top:2px;border:0;overflow:auto;resize:none; font-size:13px;"></span>');
                var $placeholder = $(this.edit.doc).find('.kindeditor-ph');
                $placeholder.html(placeholderText);
                $placeholder.css('pointerEvents', 'none');
                $placeholder.click(function(){frame.doc.body.focus()});
                if(frame.html() != '') $placeholder.hide();
            },
            afterFocus: function()
            {
                var frame = this.edit;
                var $placeholder = $(frame.doc).find('.kindeditor-ph');
                if($placeholder.size() == 0)
                {
                    setTimeout(function(){$(frame.doc).find('.kindeditor-ph').hide();}, 50);
                }
                else
                {
                    $placeholder.hide();
                }
                $editor.prev('.ke-container').addClass('focus');
            },
            afterBlur: function()
            {
                this.sync();
                $editor.prev('.ke-container').removeClass('focus');
                var frame = this.edit;
                if(K(frame.doc.body).html() == '') $(frame.doc).find('.kindeditor-ph').show();
            },
            afterTab: function(id)
            {
                var $next = $editor.next(nextFormControl);
                if(!$next.length) $next = $editor.parent().next().find(nextFormControl);
                if(!$next.length) $next = $editor.parent().parent().next().find(nextFormControl);
                $next = $next.first().focus();
                var keditor = $next.data('keditor');
                if(keditor) keditor.focus();
                else if($next.hasClass('chosen')) $next.trigger('chosen:activate');
            }
        };
        try
        {
            if(!window.editor) window.editor = {};
            var keditor = K.create('#' + editorID, options);
            window.editor['#'] = window.editor[editorID] = keditor;
            $editor.data('keditor', keditor);
        }
        catch(e){}
    });

    if($.isFunction(afterInit)) afterInit();
}
</script>
<script src='http://cdn.zentaopm.com/9.2.1/js/misc/date.js?v=pro6.3.1' type='text/javascript'></script>
<script language='Javascript'>weekend = 2;</script>
<script language='Javascript'>
    holders = {
        "code":"\u56e2\u961f\u5185\u90e8\u7684\u7b80\u79f0",
        "totalLeft":"\u9879\u76ee\u5f00\u59cb\u65f6\u7684\u603b\u9884\u8ba1\u5de5\u65f6"};</script>
<div class='container mw-1400px'>
  <div id='titlebar'>
    <div class='heading'>
      <span class='prefix'><i class='icon-folder-close-alt'></i></span>
      <strong><small class='text-muted'><i class='icon icon-plus'></i></small> 创建项目</strong>
    </div>
  </div>
    <table class='table table-form'>
      <tr>
        <th class='w-90px'>项目名称</th>
        <td class='w-p25-f'><input type='text' name='name' id='name' value='' class='form-control' autocomplete='off' />
</td><td></td>
      </tr>
      <tr>
        <th>起始日期</th>
        <td>
          <div class='input-group'>
            <input type='text' name='begin' id='begin' value='2017-07-10' class='form-control w-100px form-date' onchange='computeWorkDays()' placeholder='开始日期' />
            <span class='input-group-addon'>至</span>
            <input type='text' name='end' id='end' value='' class='form-control form-date' onchange='computeWorkDays()' placeholder='结束日期' />
          </div>
        </td>
        <td>
          &nbsp; &nbsp;
            <label class='radio-inline'>
                <input type='radio' name='delta' value='7' onclick='computeEndDate(this.value)' id='delta7' /> 一星期</label>
            <label class='radio-inline'><input type='radio' name='delta' value='14' onclick='computeEndDate(this.value)' id='delta14' /> 两星期</label>
            <label class='radio-inline'><input type='radio' name='delta' value='31' onclick='computeEndDate(this.value)' id='delta31' /> 一个月</label>
            <label class='radio-inline'><input type='radio' name='delta' value='62' onclick='computeEndDate(this.value)' id='delta62' /> 两个月</label>
            <label class='radio-inline'><input type='radio' name='delta' value='93' onclick='computeEndDate(this.value)' id='delta93' /> 三个月</label>
            <label class='radio-inline'><input type='radio' name='delta' value='186' onclick='computeEndDate(this.value)' id='delta186' /> 半年</label>
            <label class='radio-inline'><input type='radio' name='delta' value='365' onclick='computeEndDate(this.value)' id='delta365' /> 一年</label>        </td>
      </tr>
      <tr>
        <th>可用工作日</th>
        <td>
          <div class='input-group'>
          <input type='text' name='days' id='days' value='' class='form-control' autocomplete='off' />
            <span class='input-group-addon'>天</span>
          </div>
        </td>
      </tr>
      <tr>
        <th>项目类型</th>
        <td>
          <select name='type' id='types' class='form-control'>
              <option data-keys='duanqixiangmu dqxm'>个人项目</option>
              <option  data-keys='zhangqixiangmu zqxm'>团队项目</option>
          </select>
        </td>
      </tr>
      <tr>
        <th>项目描述</th>
        <td colspan='2'><textarea name='desc' id='desc' rows='6' class='form-control'></textarea></td>
      </tr>
      <tr>
          <th>邀请成员</th>
          <td>
              {% for i in data %}
                  <input type="checkbox"  value="{{ i.user_id }}" name="mymember">{{ i.name }}
              {% endfor %}
          </td>
      </tr>
      <tr>
        <td></td><td colspan='2' class='text-center'> <button type='button' id='submit' class='btn btn-primary'>保存</button><a href='javascript:history.go(-1);' class='btn btn-back ' >返回</a></td>
      </tr>
    </table>
</div>
</div>
</div>
<script>config.onlybody = 'no';</script>
<script src="/static/zui/js/messager.js"></script>
<script type="application/javascript">
    var myMessager = new $.zui.Messager({type: 'success'});
    $(document).ready(function(){
        $("#submit").click(function(){
            var name = $("#name").val();
            var begin = $("#begin").val();
            var end = $("#end").val();
            var days = $("#days").val();
            var type = $("#types option:selected").text();
            var times = $('input[name="mymember"]:checked');
            var members = new Array();
            $.each(times, function(){
                members.push($(this).val());
            });
            var content = $("#desc").val();
            if (name == "")
                myMessager.show("请输入项目名称");
            else if(type=='个人项目' && members.length > 0)
                myMessager.show("个人项目不可以邀请成员");
            else if (begin == "")
                myMessager.show("请输入起始日期");
            else if (end == "")
                myMessager.show("请输入截止日期");
            else if (content == "")
                myMessager.show("请输入项目描述");
            else(
                $.ajax({
	                url:'{% url 'save-project' %}',
                    type:'POST',
                    dataType: 'json',
                    data:{ "name": name, "begin": begin, "end": end, "days": days, "type": type, "content": content, "members": members},
                    success:function(data){
	                    if(data.status==1){
	                        myMessager.show("创建成功,请稍后......");
	                        setTimeout(function(){
	                            location.href = "{% url 'admin_project' %}";
                            },1000)

                        }else{
	                        myMessager.show(data.error);
                       }
                    }
                })
            )
        })
    })
</script>
<script language='Javascript'>function setWhite(acl)
{
    acl == 'custom' ? $('#whitelistBox').removeClass('hidden') : $('#whitelistBox').addClass('hidden');
}

function switchStatus(projectID, status)
{
  if(status) location.href = createLink('project', 'task', 'project=' + projectID + '&type=' + status);
}

function switchGroup(projectID, groupBy)
{
    link = createLink('project', 'groupTask', 'project=' + projectID + '&groupBy=' + groupBy);
    location.href=link;
}

/**
 * Convert a date string like 2011-11-11 to date object in js.
 *
 * @param  string $date
 * @access public
 * @return date
 */
function convertStringToDate(dateString)
{
    dateString = dateString.split('-');
    return new Date(dateString[0], dateString[1] - 1, dateString[2]);
}

/**
 * Compute delta of two days.
 *
 * @param  string $date1
 * @param  string $date1
 * @access public
 * @return int
 */
function computeDaysDelta(date1, date2)
{
    date1 = convertStringToDate(date1);
    date2 = convertStringToDate(date2);
    delta = (date2 - date1) / (1000 * 60 * 60 * 24) + 1;

    weekEnds = 0;
    for(i = 0; i < delta; i++)
    {
        if((weekend == 2 && date1.getDay() == 6) || date1.getDay() == 0) weekEnds ++;
        date1 = date1.valueOf();
        date1 += 1000 * 60 * 60 * 24;
        date1 = new Date(date1);
    }
    return delta - weekEnds;
}

/**
 * Compute work days.
 *
 * @access public
 * @return void
 */
function computeWorkDays(currentID)
{
    isBactchEdit = false;
    if(currentID)
    {
        index = currentID.replace('begins[', '');
        index = index.replace('ends[', '');
        index = index.replace(']', '');
        if(!isNaN(index)) isBactchEdit = true;
    }

    if(isBactchEdit)
    {
        beginDate = $('#begins\\[' + index + '\\]').val();
        endDate   = $('#ends\\[' + index + '\\]').val();
    }
    else
    {
        beginDate = $('#begin').val();
        endDate   = $('#end').val();
    }

    if(beginDate && endDate)
    {
        if(isBactchEdit)  $('#dayses\\[' + index + '\\]').val(computeDaysDelta(beginDate, endDate));
        if(!isBactchEdit) $('#days').val(computeDaysDelta(beginDate, endDate));
    }
    else if($('input[checked="true"]').val())
    {
        computeEndDate();
    }
}

/**
 * Compute the end date for project.
 *
 * @param  int    $delta
 * @access public
 * @return void
 */
function computeEndDate(delta)
{
    beginDate = $('#begin').val();
    if(!beginDate) return;

    delta     = parseInt(delta);
    beginDate = convertStringToDate(beginDate);
    if((delta == 7 || delta == 14) && (beginDate.getDay() == 1))
    {
        delta = (weekend == 2) ? (delta - 2) : (delta - 1);
    }

    endDate = beginDate.addDays(delta - 1).toString('yyyy-MM-dd');
    $('#end').val(endDate).datetimepicker('update');
    computeWorkDays();
}

/**
 * Load branches.
 *
 * @param  int $product
 * @access public
 * @return void
 */
function loadBranches(product)
{
    if($('#productsBox .input-group:last select:first').val() != 0)
    {
        var length = $('#productsBox .input-group').size();
        $('#productsBox .row').append('<div class="col-sm-3">' + $('#productsBox .col-sm-3:last').html() + '</div>');
        if($('#productsBox .input-group:last select').size() >= 2)$('#productsBox .input-group:last select:last').remove();
        $('#productsBox .input-group:last .chosen-container').remove();
        $('#productsBox .input-group:last select:first').attr('name', 'products[' + length + ']').attr('id', 'products' + length);
        $('#productsBox .input-group:last .chosen').chosen(defaultChosenOptions);
    }

    var $inputgroup = $(product).closest('.input-group');
    if($inputgroup.find('select').size() >= 2)$inputgroup.find('select:last').remove();
    var index = $inputgroup.find('select:first').attr('id').replace('products' , '');
    $.get(createLink('branch', 'ajaxGetBranches', "productID=" + $(product).val()), function(data)
    {
        if(data)
        {
            $inputgroup.append(data);
            $inputgroup.find('select:last').attr('name', 'branch[' + index + ']').attr('id', 'branch' + index).css('width', '80px');
        }
    })
}
</script>



{% endblock %}